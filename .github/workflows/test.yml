# name: myapp

# on: [push]

# jobs:
#   test:
#     name: ${{ matrix.lisp }} on ${{ matrix.os }}
#     runs-on: ${{ matrix.os }}
#     strategy:
#       matrix:
#         lisp: [sbcl-bin]
#         os: [macOS-latest, ubuntu-latest]

#     steps:
#       - uses: actions/checkout@v1
#       - name: Install Roswell
#         env:
#           LISP: ${{ matrix.lisp }}
#         run: |
#           curl -L https://raw.githubusercontent.com/roswell/roswell/master/scripts/install-for-ci.sh | sh
#       - name: Install ci-utils
#         run: ros install ci-utils
#       - name: Run 5am
#         run: |
#            PATH="~/.roswell/bin:$PATH"
#            run-fiveam -l myapp/test myapp-test:myapp

name: CI

on: [push]

jobs:
  test:
    name: ${{ matrix.lisp }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        lisp: [sbcl-bin]
        os: [ubuntu-latest, macOS-latest, windows-2019]

    steps:
      - uses: actions/checkout@v1
      - name: Install Roswell (Ubuntu & macOS)
        if: matrix.os != 'windows-2019'
        env:
          LISP: ${{ matrix.lisp }}
        run: |
          curl -L https://raw.githubusercontent.com/roswell/roswell/master/scripts/install-for-ci.sh | sh

      - name: Install MSYS2
        if: matrix.os == 'windows-2019'
        run: |
          choco install msys2
      - name: Build and (hopefully) install package (Windows)
        if: matrix.os == 'windows-2019'
        run: C:\tools\msys64\usr\bin\bash -lc "./msys2-mingw/run.sh -b"
        env:
          HOME: ${{ runner.workspace }}/myrepo
          MINGW_INSTALLS: ${{ matrix.task.installs }}
      - name: Test package (Windows)
        if: matrix.os == 'windows-2019'
        run: C:\tools\msys64\usr\bin\bash -lc "source /usr/bin/shell $MINGW_INSTALLS; ./msys2-mingw/run.sh -t"
      - name: Install Roswell (Windows)
        if: matrix.os == 'windows-2019'
        env:
          LISP: ${{ matrix.lisp }}
          ROSWELL_INSTALL_DIR: /c/roswell
        run: |
          curl -L https://raw.githubusercontent.com/roswell/roswell/master/scripts/install-for-ci.sh | sh
      - name: Install ci-utils
        run: ros install ci-utils
      - name: Run tests (Ubuntu & macOS)
        if: matrix.os != 'windows-2019'
        run: |
          PATH="~/.roswell/bin:$PATH"
          run-fiveam -l myapp/test myapp-test:myapp
      - name: Run tests (Windows)
        if: matrix.os == 'windows-2019'
        run: |
          /c/roswell/bin/ros -S . -s fiveam -e '(asdf:test-system "myapp")'
